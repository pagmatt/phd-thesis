% \usepackage{multirow}
% \usepackage{subcaption}
% \usepackage{tikz}
% \usepackage{pgfplots}
% \pgfplotsset{compat=newest}
% \pgfplotsset{plot coordinates/math parser=false}
% \newlength\fheight
% \newlength\fwidth
% \usetikzlibrary{plotmarks,decorations,backgrounds,calc,spy}
% \usetikzlibrary{decorations.markings}
% \usepgfplotslibrary{patchplots,groupplots}
% \usepackage{tikzscale}
% \usepackage{graphicx}

\newacronym{geo}{GEO}{Geostationary Equatorial Orbit}
\newacronym{meo}{MEO}{medium earth orbit}
\newacronym{leo}{LEO}{Low Earth Orbit}
\newacronym{vsat}{VSAT}{very small aperture terminal}
\newacronym{nb}{NB}{node base}
\newacronym{hap}{HAP}{High Altitute Platform}
\newacronym{mtc}{MTC}{machine type communications}
\newacronym{miot}{mIoT}{massive internet of things}
\newacronym{gcs}{GCS}{global coordinate system}
\newacronym{lcs}{LCS}{local coordinate system}
\newacronym{isl}{ISL}{inter-satellite link}
\newacronym{ecef}{ECEF}{Earth-Centered Earth-Fixed}
\newacronym{fspl}{FSPL}{free space path loss}
\newacronym{cnr}{CNR}{carrier-to-noise ratio}

%\section{Introduction}

%The rest of the paper is organized as follows. In Sec.~\ref{sec:channel} we describe the 3GPP channel for NTN, while our ns-3 implementation is reported in Sec.~\ref{sec:implementation}. In Sec.~\ref{sec:results-ntn} we validate the accuracy of our module against the 3GPP calibration results reported in 38.821~\cite{38821}. Then, we provide numerical results to measure the link-level and end-to-end performance as a function of different NTN parameters. Finally, Sec.~\ref{sec:conclusions} concludes the paper with suggestions for future research. 

%The implementation process is strictly related to the \gls{3gpp} recommendations for \gls{ntn} design, following the proposed procedures and methods, since they offer the state of the art regarding channel modeling, with parameters gathered in simulation campaigns in collaboration with industry leader organizations. All the created code undergoes a resource optimization analysis, being careful to use the appropriate data structures offered by C++ depending on the type of use and the size, staying coherent with the performance optimized ns-3. Furthermore, when a lack of guideline from \gls{3gpp} is found on certain matters and details, investigation in latest research findings is done to bring results as updated and as close to reality as possible.

\section{The 3GPP Channel Model for Non-Terrestrial Networks}
\label{sec:channel}
The channel model for \gls{ntn} has been formalized by the \gls{3gpp} in TR 38.811~\cite{38811}, and is based on the structure of the cellular channel model described in TR 38.901 \cite{TR38901}, already implemented in ns-3~\cite{zugno20implementation}. 
Following this rationale, in the following subsections we describe the \gls{ntn} channel model, including path loss, absorption, fading, and antenna models, as well as the coordinate system for satellites. 


\subsection{Scenarios and Path Loss Condition}
Similarly to the cellular channel model in \cite{TR38901}, the \gls{ntn} model gives the option to run simulations in four {scenarios}, to represent different propagation environments. Specifically:
\begin{itemize}
    \item Dense Urban: Extremely dense environment, with tall buildings acting as potential blockers.
    \item Urban: City environment, with buildings.
    \item Suburban: Small city, with up to two-storey buildings.
    \item Rural: Open field environment, with little or no buildings.
\end{itemize}
For satellites, only outdoor communication is possible, since attenuation from buildings would be enough to make the signal unusable. For \glspl{hap} or \glspl{uav}, instead, indoor communication is feasible, even though not yet implemented in our module. 

The 3GPP defines both \gls{los} and \gls{nlos} propagation, where the probability depends on the scenario and the elevation angle. The latter is defined as the angle between the horizon plane of the ground terminal and the vector pointing to the NTN platform. 

\subsection{Path Loss}
The basic path loss (in dB) can be written as
\begin{equation}
    PL_{b} = FSPL(d,f_{c})+SF+CL(\alpha,f_{c}).
    \label{eq:pl-fsp}
\end{equation}
The first term is the free space path loss, which can be calculated as
\begin{equation}
    FSPL(d,f_{c}) = 32.45 + 20log_{10}(f_{c}) + 20log_{10}(d),
\end{equation}
where $f_{c}$ is the carrier frequency in GHz and $d$ is the distance beteween the transmitter and the receiver in meters.
Notice that, while the channel model is valid for frequencies from 0.5 GHz to 100 GHz, two frequency bands are targeted in NTN, i.e., the S-band for frequencies below 6 GHz and the Ka-band for frequencies of 20 (30) GHz for downlink (uplink) transmissions, thereby in the millimeter-wave spectrum~\cite{giordani2020satellite}.

In Eq.~\eqref{eq:pl-fsp}, $SF$ represents the \gls{sf}, and is modeled as a log-normal random variable of zero mean and variance $\sigma_{SF}^2$, i.e., $SF \sim N\left ( 0,\sigma_{SF}^{2} \right )$. In order to calculate this variance, the model requires four parameters: the type of scenario, the frequency, the path loss condition (\gls{los} or \gls{nlos}), and the elevation angle. These parameters are used to find the correct entry in a table, given in~\cite{38811}.
A similar process is needed to calculate the clutter loss $CL(\alpha,f_{c})$.


\subsection{Atmospheric Absorption}
\label{sub:atm}
The attenuation introduced by the presence of atmospheric gasses was a marginal factor in the terrestrial channel.
%being left to calculation only in peculiar simulation. 
This is no longer the case for the \gls{ntn} channel, where atmospheric absorption plays a crucial role in the overall link budget. 
A complete and accurate characterization of the atmospheric attenuation is given in the ITU model~ \cite{itup676}, and depends on a set of parameters which is usually difficult to retrieve in simulations, such as absolute humidity, dry air pressure, water-vapour density and water-vapour partial pressure. 
Therefore, the \gls{3gpp} offers a simplified method considering only ground users placed at the sea level, with an elevation angle fixed to 90 degrees, and considering mean annual global values for the rest of the parameters. 
For elevation angles different than 90 degrees, the calculation is straightforward. Given the zenith attenuation $A_{zenith}(f_{c})$, the additional path loss due to atmospheric gasses is
\begin{equation}
    PL_{A,dB}\left ( \alpha,f_{c} \right )=\frac{A_{zenith}\left ( f_{c} \right ) }{sin(\alpha)},
\end{equation}
where $\alpha$ is the actual elevation angle.
Atmospheric absorption should be considered only for frequencies above 10 GHz, or for any frequency in case of $\alpha<10$ degrees.

\subsection{Scintillation}
Scintillation corresponds to the rapid fluctuation in amplitude and phase of the received signal, caused by the variation of the refractive index of the channel. 
Specifically, scintillation depends on location, time of the day, season, and solar and geomagnetic activity. Stronger levels of scintillation are observed only at high latitudes  (more than 60 degrees), in auroral and polar regions. 


While a complete absorption model would unnecessarily complicate system-level simulations, the 3GPP recommends a simplified model for scintillation~\cite{38811}, which is structured into two components: ionospheric scintillation and tropospheric scintillation.


\subsubsection{Ionospheric Scintillation}
Ionospheric scintillation is modeled based on the Gigahertz Scintillation Model~\cite{itup531}. While for the purpose of systemâ€“level simulations ionospheric scintillation is generally negligible at mid latitudes (between 20 and 60 degrees) or at above-6 GHz frequencies, in all other latitudes and conditions it is modeled as
\begin{equation}
    PL_{S,dB} = \left ( \frac{f_{c}}{4} \right )^{-1.5}\frac{P_{fluc}\left ( 4 \text{ GHz} \right )}{\sqrt{2}},
\end{equation}
where $f_{c}$ is the carrier frequency, and $P_{fluc}\left ( 4 \text{ GHz} \right )$ is a scaling factor representing the ionospheric attenuation level at 99\% of the time observed in Hong Kong between March 1977 and March 1978 at a frequency of 4 GHz~\cite[Fig.~6.6.6.1.4-1]{38811}.

\subsubsection{Tropospheric Scintillation}
Unlike ionospheric scintillation, the effect of tropospheric scintillation increases with the frequency, and becomes significant above 10 GHz. Furthermore, it increases at low elevation due to the longer path of the signal.  %\gls{3gpp} recommends considering the path loss induced by this effect only in certain cases, and offers a direct method for calculation. 
In these conditions, tropospheric scintillation is due to sudden changes in the refractive index due to the variation of temperature, water vapor content, and barometric pressure. For system-level simulations, the additional attenuation due to tropospheric scintillation is modeled as the attenuation level at 99\% of the time observed in Tolouse at 20 GHz, reported in~\cite[Fig.~6.6.6.2.1-1]{38811}. 

\subsection{Fast Fading}
As far as the fading is concerned, the 3GPP introduces both a flat-fading and a frequency-selective model. 
The flat-fading model, however, can be applied only if specific conditions are met, including (i) minimum elevation angle of 20 degrees, (ii) quasi-LOS propagation, (iii) communication in the S-band, (iv) channel bandwidth of at most 5 MHz, and (v) rural, suburban or urban scenario.
Hence, we consider the more general, though complex, frequency-selective fading model for \gls{ntn}. Then, the fading is based on the TR 38.901 model for cellular networks~\cite{TR38901} (already implemented in ns-3 in the \texttt{mmwave} module~\cite{zugno20implementation}), but with different parameters as described  in~\cite[Sec.~6.7.2]{38811}.

\subsection{Antenna Model}
Different antenna models are defined, depending on the device (satellite, HAP or UAV, and ground terminal). 
For satellites, the \gls{3gpp} suggests to use a circular aperture antenna model. Circular aperture antennas are reflector antennas that offer circular polarization. The normalized antenna gain pattern is given by
\begin{equation}
\label{eq:eq4}
    G(\theta) =
    \begin{cases}
    1  & \theta=0; \\
    4\left | \frac{J_{1}\left ( k\cdot \ell\cdot sin\theta \right )}{k\cdot \ell\cdot sin\theta} \right |^{2} & 0<\left | \theta \right |\leq 90^{\circ},
    \end{cases}
\end{equation}
where $J_{1}(\cdot)$ is the Bessel function of the first kind and first order, $\ell$ is the radius of the antenna's circular aperture and, given a carrier frequency  $f_{c}$, the value of $k$ is equal to $k={2\pi f_{c}}/{c}$, where $c$ is the speed of light in vacuum.

When considering flying vehicles that are not satellites, such as \glspl{hap} or \glspl{uav}, the lower distance makes it possible to use \gls{upa} antennas, that is the current standard for \glspl{ue} and eNB/gNB nodes in cellular networks according to the TR 38.901 model~\cite{TR38901}.

Finally, for terrestrial terminals, the 3GPP suggests to use either \gls{upa} antennas or \gls{vsat} antennas. The latter model, in particular, is a common choice in satellite communication, and consists of a circular reflector antenna of small size (less than 1 m of diameter), to be typically placed on roofs pointing at the sky. The \gls{vsat} radiation pattern is the same as that of circular aperture antennas for satellites, and is given in Eq.~\ref{eq:eq4}.

\subsection{Coordinate System}
\label{sec:coord_model}
In general, the 3GPP defines a simple Cartesian coordinate system where the position of each node is uniquely described by a set of three values, $(x,y,z)$, where $x$ and $y$ define the ground plane, and $z$ represents the height of the node. 
While this model is accurate enough to describe scenarios where nodes are deployed at close distance (e.g., a few hundreds of meters), it is not for scenarios where end nodes are placed hundred (or thousands) of kilometers apart such as in the NTN environment. In this case, the Earth's curvature, as well as the elevation angle, play an important role.
Therefore, the \gls{3gpp} suggests to use a Geocentric Cartesian coordinate system (or \gls{ecef} system), where the position of a node is still described by three values $(x,y,z)$, but now the origin of the axes lays in the center of the Earth, which is modeled as a sphere of radius $R=6\,371$ km. 
The x-y plane defines the equatorial plane, with the x-axis pointing at 0-degree longitude, the y-axis pointing at 90-degree longitude, and the z-axis pointing at the geographical North Pole. 
Then, terrestrial nodes on the surface of the Earth are deployed so that $\sqrt{x^{2}+y^{2}+z^{2}}=R$, while aerial/space nodes flying/orbiting around the Earth are deployed so that $\sqrt{x^{2}+y^{2}+z^{2}}> R$.


\section{Implementation}
\label{sec:implementation}
%The creation of the \gls{ntn} channel model follows the \gls{3gpp}~\cite{38811} guidelines presented in the previous section, which are considered a standard in the telecommunication landscape.  
The proposed ns-3 implementation of the 3GPP TR 38.811~\cite{38811} \gls{ntn} channel model is based upon the TR 38.901 model presented in~\cite{zugno20implementation}. Despite the fact that the newly introduced methods and classes are designed with the goal of introducing minimal changes to the existing ns-3 APIs, %, thus minimal change to existing classes is preferred.Nevertheless, 
some modifications to the existing code structure are still required. A schematic of these changes, which we make publicly available\footnote{\url{https://gitlab.com/mattiasandri/ns-3-ntn/-/tree/ntn-dev}}, can be found in Fig.~\ref{fig:ntn-uml}.

\begin{figure*}[t]
    \includegraphics[width=\textwidth]{Figures/ChannelNtn/uml-diagram.png}
    \caption{Simplified UML diagram, which depicts the most significant changes which we introduced to ns-3. Bold classes represent the newly implemented ones, while dotted classes are pre-existing ones that have been modified.}
    \label{fig:ntn-uml}
\end{figure*}

The remainder of this section describes more in detail our implementation of the NTN channel model of~\cite{38811} in ns-3. 

%\subsection{ThreeGppChannelModel}
\subsection{Small-scale fading}
The most significant modifications to the pre-existing ns-3 classes concern the \texttt{Three\-Gpp\-Channel\-Model} class, which computes the small-scale propagation phenomena in the form of a complex channel matrix. Indeed, conversely from the procedure implemented in \cite{zugno20implementation}, in the \gls{ntn} channel model of~\cite{38811} most channel parameters depend on all the propagation scenario, \gls{los} condition, carrier frequency and elevation angle variables.  
To account for this, we store the small-scale fading parameters in a \emph{nested map}. The choice of this data-structure is motivated by the good trade-off between code efficiency and readability which it provides, considering that the possible combinations of the input parameters is particularly high, i.e., $144$.
%Taking into consideration four scenarios, two \gls{los} condition, two frequency band and nine elevation angle the final possible choices for a single parameters are 144. Given that the small scale parameters are more than 30 total values, a proper holding structure is needed to guarantee  bringing the choice to 

In particular, we change the signature of the \texttt{GetThreeGppTable()} method to include the \texttt{Mobility\-Model} instances of both transmitting and receiving nodes. In such a way, we account for the dependence of the small scale parameters with respect to the elevation angle, which the model of~\cite{38811} exhibits.
Finally, we include the required angular scaling factors for the propagation scenarios that have a lower number of clusters than the ones described in TR 38.901~\cite{TR38901}.

\subsection{Coordinate systems}
Instead of the coordinate system described in~\cite{TR38901}, the NTN channel model of~\cite{38811} considers the \emph{Geocentric Cartesian} (or \gls{ecef}) coordinate system.
We introduce this reference system in ns-3 via the \texttt{Geographic\-Positions} class, which provides methods to translate points represented using the coordinate system of~\cite{TR38901} to/from those of~\cite{38811}. 

Moreover, with usability in mind, we also implement a geographic coordinate system which allows ns-3 user to specify positions using the system of~\cite{38811} in a more convenient manner. This auxiliary reference system represents positions as points exhibiting a relative altitude from their projection on the surface of the Earth. That is to say, any location on, or possibly above, Earth is referenced by a longitude $\phi$, a latitude $\lambda$ and an altitude $h$. 
To this end, we implement in the \texttt{Geographic\-Positions} class the methods \texttt{Geographic\-To\-Topocentric\-Coordinates} and \texttt{Topocentric\-To\-Geographic\-Coordinates}, which can be used to translate positions between geocentric and non-geocentric geographic coordinate systems.

For the conversion between any of the newly introduced models, and the cartesian reference system of~\cite{TR38901}, we introduce a \emph{reference point} of translation between the two classes of coordinate systems, following the procedure outlined in \cite[Ch.~4]{coordinateconversion}.
%To conversion between a coordinate system that places a terminal on a location of the Earth to one in which the node position lays in a imaginary plane,  Coordinates that uses a reference point of origin are called \emph{topocentric coordinates}, or \gls{enu} coordinates.

\subsection{Channel condtion}
To model the channel condition for the \gls{ntn} propagation scenarios, we create the classes: 
\begin{itemize}
    \item \verb|ThreeGppNTNDenseUrbanChannelConditionMode|;
    \item \verb|ThreeGppNTNUrbanChannelConditionMode|;
    \item \verb|ThreeGppNTNSuburbanChannelConditionMode|; and
    \item \verb|ThreeGppNTNRuralChannelConditionMode|.
\end{itemize}
Each of these derives from the base class \texttt{Three\-Gpp\-Channel\-Condition\-Mode}|, which in turn implements the \texttt{Channel\-Condition\-Model} interface.

%The \texttt{ChannelCondition} class was developed to store the channel state, together with the interface \verb|ChannelConditionModel| that can be extended to implement any specific channel condition. The main method is \verb|GetChannelCondition|, which given two mobility models returns a pointer to the corresponding \verb|ChannelCondition|.
These channel condition classes interact with the remainder of the \texttt{spectrum} module as follows.
Whenever the \texttt{Get\-Channel\-Condition} method is called, the newly introduced NTN \texttt{Channel\-Condition\-Model} classes compute the channel state and cache it, along with its generation time. Then, the following calls to \texttt{Get\-Channel\-Condition} retrieve the previously stored value, if it has not expired. Otherwise, they compute a new \gls{los} condition. 

\subsection{Path loss and shadowing}
We implement the path loss and shadowing models of~\cite{38811} in four different classes, as depicted in Fig.~\ref{fig:ntn-uml}. The latter extend the \texttt{Three\-Gpp\-Propagation\-Loss\-Model} class, which in turn implements the \texttt{Propagation\-Loss\-Model} interface.

The classes which implement this interface shall override the \texttt{Do\-Calc\-Rx\-Power}, returning the received power based on the positions of the communicating endpoints, and when considering frequency-flat phenomena only. 
In the case of the \gls{ntn} propagation scenarios of~\cite{38811}, these phenomena comprise the typical free space path loss, on top of tropospheric and ionospheric scintillation, shadow fading, clutter loss, and atmospheric absorption.

%The latter perform the power calculation using \verb|GetLossLos|, \verb|GetLossNlos|  and \verb|GetShadowing| to get the mean total pathloss. %Since the shadowing loss is modeled as a log-normal random variable, it's calculation require the \verb|GetShadowingStd| method, that returns the standard deviation value for a specific scenario. 

\subsection{Geocentric mobility models}
\label{sub:mobility}
%The creation of a , comes primarily from the need of calculating the elevation angle, which is essential in the estimation of many channel parameters. 
Along with the geographic coordinate systems, we implement a new mobility model, i.e., \texttt{Geocentric\-Constant\-Position\-Mobility\-Model}, which allows ns-3 users to position nodes using real world coordinates.
Specifically, the latter class stores positions via the variable \verb|m_position|, which specifies their geographic coordinates.

When using these mobility models, the position of a node can be retrieved (set) using the methods \texttt{Get\-Geographic\-Postion} (\texttt{Set\-Geographic\-Postion}) and \texttt{Get\-Geocentric\-Position} (\texttt{Set\-Geocentric\-Position}). In turn, these methods rely on the functionality provided by the class \texttt{Geographic\-Position} for translating between different coordinate systems. 

Notably, the conversion from geocentric cartesian or geographic coordinates, to the coordinate systems used by ns-3, uses by default the so-called reference point ``{Null Island}'' $(0,0,0)$. Nevertheless, ns-3 users are given the possibility of tuning this value by using the \texttt{Geocentric\-Constant\-Position\-Mobility\-Model} attribute \texttt{Set\-Coordinate\-Translation\-Reference\-Point}.

%The \verb|GeocentricConstantPositionMobilityModel| class is derived from the base class \verb|MobilityModel|, which imposes the presence of the \verb|Get/SetPosition()| methods, that are used to set and get the position of the object using planar Cartesian coordinates. 

%which implements the \texttt{Mobility\-Model} interface

%Hence, conversion to and from this coordinates is crucial to
%Additionally, the reference point for coordinates conversion can be set using, making the values obtained when using \verb|GetPosition()| more human readable.

\subsection{Antenna models}
The circular aperture reflector antenna model currently implemented in ns-3, i.e., \texttt{Parabolic\-Antenna\-Model}, is based on a parabolic approximation of the main lobe radiation pattern, as described in~\cite{parabolicantenna3gpp} and~\cite{parabolicantennamodel}. This simplification reduces the computational complexity of the field pattern calculation, by avoiding the Bessel functions evaluations that the circular aperture antenna would require, and using trigonometric approximations instead. 

As part of our contributions, we leverage the efficient implementation of the Bessel functions which has been introduced with C\texttt{++}17 to implement an exact circular aperture reflector antenna model. Specifically, we introduce this functionality extending the \texttt{Antenna\-Model} via the \texttt{Circular\-Aperture\-Antenna\-Model} class.
The latter allows ns-3 users to steer the pointing direction of the antenna via the \texttt{Set\-Orientation} and \texttt{Set\-Inclination} methods.
%, and overrides the \verb|GetGainDb| method of the base class using the proper field pattern calculation. 
Similarly, the operating frequency and the aperture radius %are essential parameters to correctly estimate the radiation pattern of a circular aperture antenna, thus 
can be tuned by using the methods \texttt{Set\-Operating\-Frequency} and \texttt{Set\-Aperture\-Radius}.

\section{Examples and Comparisons}
\label{sec:results-ntn}
In this section we validate the accuracy of our ns-3 module for the NTN channel, and compare simulation results with the calibration reported in TR 38.821 \cite{38821}. Furthermore, we provide numerical results to measure link-level and end-to-end performance (including throughput and packet drop ratio). We focus on satellites, even though the model is valid for different NTN scenarios.

\subsection{Link-Level Results}
\label{sub:ll}
While ns-3 enables system-level simulations, an evaluation of the link-level performance is still useful to validate the technical accuracy of our module. Hence, in this section we run link-level simulations to compare the calibration results from the 3GPP~\cite{38821} with results from our module. 

The 3GPP identifies 30 calibration study cases~\cite[Tab.~ 6.1.1.1-9]{38821}, which include a combination of different satellite orbits, frequency bands, and antenna configurations for the ground terminal. Link-level calibration results are reported in~\cite[Tab.~6.1.1.2]{38821}, including results for the \gls{fspl}, atmospheric loss (AL) and scintillation loss (SL), and the \gls{cnr}. 
Specifically, the \gls{cnr} is calculated as described in \cite[Sec.~6.1.3.1]{38821}. 

% Please add the following required packages to your document preamble:
% \usepackage{multirow}
\begin{table}[t!]
\caption{Link-level comparison between the 3GPP calibration results (``3GPP'') and those obtained in simulations (``Obtained''). Header acronyms:  Free Space Path Loss (FSPL), Atmospheric Loss (AL), Scintillation Loss (SL), Carrier-to-Noise Ratio (CNR). All values are in dB.}
\label{tab:ll-comp}
\vspace{-0.3cm}
\begin{tabular}{|c|l|l|l|l|l|l|}
\hline
\textbf{SC} & \textbf{Tx} & \textbf{Source} & \textbf{FSPL} & \textbf{AL} & \textbf{SL} & \textbf{CNR} \\ \hline
\multirow{2}{*}{1} & \multirow{2}{*}{DL} & 3GPP & 210.6 & 1.2 & 1.1 & 11.6 \\
 &  & Obtained & 210.6 & 1.4 & 1.1 & 11.3 \\ \hline
\multirow{2}{*}{1} & \multirow{2}{*}{UL} & 3GPP & 214.1 & 1.1 & 1.1 & 0.5 \\
 &  & Obtained & 214.2 & 1.4 & 1.1 & 0.1 \\ \hline
\multirow{2}{*}{6} & \multirow{2}{*}{DL} & 3GPP & 179.1 & 0.5 & 0.3 & 8.5 \\
 &  & Obtained & 179.9 & 0.5 & 0.3 & 8.6 \\ \hline
\multirow{2}{*}{6} & \multirow{2}{*}{UL} & 3GPP & 182.6 & 0.5 & 0.3 & 18.4 \\
 &  & Obtained & 182.6 & 0.5 & 0.3 & 18.4 \\ \hline
\multirow{2}{*}{9} & \multirow{2}{*}{DL} & 3GPP & 159.1 & 0.1 & 2.2 & 6.6 \\
 &  & Obtained & 159.1 & 0.0 & 2.2 & 6.7 \\ \hline
\multirow{2}{*}{9} & \multirow{2}{*}{UL} & 3GPP & 159.1 & 0.1 & 2.2 & 2.8 \\
 &  & Obtained & 159.1 & 0.0 & 2.2 & 2.4 \\ \hline
\multirow{2}{*}{14} & \multirow{2}{*}{DL} & 3GPP & 164.5 & 0.1 & 2.2 & 7.2 \\
 &  & Obtained & 164.5 & 0.0 & 2.2 & 7.3 \\ \hline
\multirow{2}{*}{14} & \multirow{2}{*}{UL} & 3GPP & 164.5 & 0.1 & 2.2 & -2.6 \\
 &  & Obtained & 164.5 & 0.0 & 2.2 & -3 \\ \hline
\end{tabular}
\end{table}

For this comparison we selected four study cases, considering both \gls{ul} and \gls{dl} transmissions, that illustrate four  representative NTN scenarios. Specifically: 
\begin{itemize}
    \item Study Case 1 (SC1): GEO satellite, 45 degrees of elevation, VSAT antenna for the ground terminal,	Ka-band.
    \item Study Case 6 (SC6): LEO satellite at 600 km, 90 degrees of elevation, VSAT antenna for the ground terminal,	Ka-band.
    \item Study Case 9 (SC9): LEO satellite at 600 km, 90 degrees of elevation, UPA antenna for the ground terminal,	S-band.
    \item Study Case 14 (SC14): LEO satellite at 1200 km, 90 degrees of elevation, UPA antenna for the ground terminal,	S-band.
\end{itemize}
The complete list of parameters used in the calibration can be found in \cite[Sec. 6.1]{38821}. 
In Tab.~\ref{tab:ll-comp} we report the calibration results (``3GPP'') and those from our simulations (``Obtained''). We can see that, despite some minor variations, numerical result are compatible under all metrics, thereby validating the accuracy of our module. 
As expected, the \gls{fspl} increases as the distance between the ground terminal and the satellite , as well as the carrier frequency, increase, due to the more severe effect of atmospheric losses. In particular, the impact of the carrier frequency is quite significant: for LEO satellites, for example, the \gls{fspl} grows from around 160 dB in the S-band (SC6) to around 180 dB in the Ka-band (SC9). In any case, we can see that,  even considering long-rage GEO satellites in the Ka-band, the \gls{cnr} is large enough to support adequate levels of communication, especially in downlink. 
We shed light on two main trends. First, uplink communication is generally worse than downlink, except for SC6. This is reasonable, and due to the fact that ground terminals are more constrained in terms of power availability, capacity, and size (e.g., for antenna deployment).
Second, according to the 3GPP model, LEO satellites have more severe hardware constraints than GEO satellites (e.g., LEO's effective isotropic radiated power (EIRP) in the Ka-band is as low as 36 dBW, vs. 66 dBW for GEO): as a result, the CNR for SC6 is around 50\% lower than for SC1, which makes LEO communication more~difficult.


\subsection{Frequency Test}
While the 3GPP identifies the S-band (at 2 GHz) and the Ka-band (at 20 GHz for \gls{dl} and 30 GHz for \gls{ul}) as frequencies of interests, the NTN channel model is valid for a wide range of frequencies, from 0.5 GHz to 100 GHz. 
Therefore, in Fig.~\ref{fig:frequency-test} we plot the \gls{snr}, which is an indication of the quality of the channel, as a function of the carrier frequency, with a resolution of 8 MHz. The other parameters are summarized in Tab.~\ref{tab:frequency-test}.

% Please add the following required packages to your document preamble:
% \usepackage{multirow}
\begin{table}[t!]
\caption{Simulation parameters.}
\label{tab:frequency-test}
\begin{tabular}{|l|l|}
\hline
\textbf{Parameter} & \textbf{Value} \\ \hline
{Frequency} & {20 GHz $\div$ 100 GHz} \\\hline
{Satellite orbit} & {GEO} \\\hline
{Satellite altitude} & {35\,786 km} \\\hline
{Elevation angle} & {90 deg} \\\hline
{Tx. mode} & {Downlink} \\\hline
{Transmit power} & {37.5 dBm} \\\hline
{Satellite  antenna} & {Circular aperture (Gain: 58.5 dB)} \\\hline
{Terminal antenna} & {VSAT (Gain: 39.7 dB)} \\\hline
 {Scenario} & {Suburban} \\\hline
\end{tabular}
\end{table}

We observe that the \gls{snr} decreases linearly (in the log scale) as the frequency increases, with a deep degradation at 60 GHz. This is because of the impact of atmospheric absorptions described in Sec.~\ref{sub:atm}, more specifically the additional signal attenuation experienced at 60 GHz due to oxygen absorption (as large as 15 dB/km).

\begin{figure}[t]
    \centering 
% These two commands set the width and height of the figure, respectively
    \setlength\fwidth{0.85\columnwidth}
    \setlength\fheight{0.33\columnwidth}
    \input{Figures/ChannelNtn/freq_test.tex}
    \caption{The SNR for different carrier frequencies. We consider a GEO satellite, with the parameters in Tab.~\ref{tab:frequency-test}.}
    \label{fig:frequency-test}
\end{figure}

\subsection{Mobility Test}
Our new mobility model for NTN (see Sec.~\ref{sub:mobility}) allows to change the position of the nodes during the simulation, thus to evaluate the effect of different parameters such as the elevation angle, the antenna radiation pattern, and the altitude. 

First, we run simulations where we iteratively change the coordinates of a satellite, which traces an arc of 6 degrees in the GEO orbit (from 8.8 to 14.8 degrees of longitude). %The altitude is constant. 
The receiving node on the ground is deployed so that it is perpendicular to the satellite in the mid point of its trajectory. The rest of the parameters are set as in Tab.~\ref{tab:frequency-test}. Notably, the orientation of the antenna is not changed during the simulation, so that satellite and ground terminal are perfectly aligned only when the former is exactly perpendicular to the latter. 
In Fig.~\ref{fig:movement-test} we plot the corresponding \gls{snr}, which resembles the circular antenna radiation pattern of the satellite as per Eq.~\eqref{eq:eq4}, which therefore defines the power profile of the received signal.

\begin{figure}[t]
    \centering 
% These two commands set the width and height of the figure, respectively
    \setlength\fwidth{0.79\columnwidth}
    \setlength\fheight{0.33\columnwidth}
    \input{Figures/ChannelNtn/movement_test.tex}
    \caption{The SNR for different angular positions of a GEO satellite, with the parameters in Tab.~\ref{tab:frequency-test}.}
    \label{fig:movement-test}
\end{figure}

Second, in Fig.~\ref{fig:altitude-test} we plot the SNR for different  values of the altitude of the satellite, from 300 to 1\,600 km to consider different LEO satellite architectures. We see that the SNR decreases as the altitude of the satellite increases, even though it is consistently above 0 dB in all configurations.

\begin{table}[t]
\caption{End-to-end performance. Acronyms: Orbit Type (OT), Transmit power (TxP), Throughput (TP), Drop Rate (DR), Frequency Band (FB), Terminal antenna (TA).}
\label{tab:systemlev}
\begin{tabular}{|l|l|l|l|l|}
\hline
\textbf{SC} & \textbf{1} & \textbf{6} & \textbf{9} & \textbf{14} \\ \hline
\textbf{OT}       & GEO & \multicolumn{2}{c|}{LEO (600 km)} & LEO (1200 km) \\ \hline
\textbf{TxP}       & 37.52 dBm & 21.52 dBm & 48.77 dBm & 54.77 dBm \\ \hline
\textbf{FB} & Ka-band   & Ka-band   & S-band    & S-band    \\ \hline
\textbf{TA}    & VSAT      & VSAT      & UPA  & UPA  \\ \hline
\textbf{TP}     & 3.811 Mbit/s   & 3.286 Mbit/s      & 4.101 Mbit/s      & 5.161 Mbit/s        \\ \hline
\textbf{DR}      & 0.61      & 0.67      & 0.45      & 0.36      \\ \hline
\end{tabular}
\end{table}


\begin{figure}[t]
    \centering 
% These two commands set the width and height of the figure, respectively
    \setlength\fwidth{0.85\columnwidth}
    \setlength\fheight{0.33\columnwidth}
    \input{Figures/ChannelNtn/altitude_test.tex}
    \caption{The SNR for different values of the altitude of a LEO satellite, with the parameters in Tab.~\ref{tab:frequency-test}.}
    \label{fig:altitude-test}
\end{figure}

\subsection{End-to-End Performance}
Unlike other simulators, ns-3 incorporates an accurate model of the whole ISO/OSI protocol stack, thus enabling scalable end-to-end simulations. Notably, end-to-end results can be collected to validate and measure the performance of communication networks, so ns-3 stands out as a valid tool to dimension NTN systems too.
To do so, we consider a downlink application transmitting data (in the form of UDP packets) at a constant rate of 10 Mbit/s. We test the four study cases presented in Sec.~\ref{sub:ll}, so to consider both GEO and LEO satellites, and different altitudes, antenna configurations, and both communication in the Ka- and S-band. 
Simulations results are reported in Tab.~\ref{tab:systemlev} in terms of end-to-end throughput (TP) and packet drop rate (DR), which is defined as the ratio between the number of received packets and the total number of packets sent at the application layer.
We observe that both GEO-to-ground and LEO-to-ground communication is feasible, provided that the satellite operates with large-scale antennas offering fine-grained beams on the ground, and at high transmit power. 
Notice that the DR is quite significant, especially in the Ka-band, which requires the design of appropriate Automatic Repeat reQuest (ARQ) schemes to deal with retransmissions.


\section{Conclusions}
\label{sec:conclusions}
This paper presented an ns-3 implementation of the \gls{3gpp} channel model for NTN, developed following the specifications provided in \cite{38811}.
The code, which is publicly available at~\cite{ntngitlab}, well integrates with the rest of the ns-3 framework, and enables full-stack end-to-end simulations in different \gls{ntn} scenarios. After introducing the 3GPP NTN channel, we described in detail our ns-3 implementation, including simulation scenarios, new attenuation, fading, and mobility models for the space/air channel, and a new coordinate system specifically tailored to satellites. Finally, we run link-level and end-to-end simulations to validate the accuracy of our module, also against 3GPP calibration results reported in~\cite{38821}.

As part of our future work, we plan to further extend our NTN module to incorporate additional functionalities, for example a delay model able to accurately characterize the propagation time, the support for moving nodes in orbits, and the simulation of ground terminals in indoor scenarios.
